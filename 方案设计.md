# 技术方案设计：个人文件中转站

---

## Step 1：需求回顾

根据需求文档 [1]，核心信息如下：

| 维度 | 内容 |
|------|------|
| **核心角色** | 单管理员 + 匿名访客 |
| **核心功能** | 管理员上传/管理文件；访客凭链接（+可选提取码）下载 |
| **交互方式** | Web 界面 |
| **版本** | v1.0（轻量级个人项目）|

> ⚠️ **需求文档仅提供了部分内容**，以下方案基于"个人文件中转站"的通用场景进行合理推断补全，请确认后调整。

---

## Step 2：技术选型

### 选型表

| 层次 | 技术选择 | 备选 | 选型理由 |
|------|----------|------|----------|
| **前端框架** | Vue 3 + Vite | React | 轻量、生态好，适合小型后台 |
| **UI 组件库** | Element Plus | Ant Design Vue | 与 Vue 3 契合，文件管理组件丰富 |
| **后端框架** | Node.js + Express / **Python FastAPI** | Spring Boot | 个人项目轻量部署，FastAPI 开发效率高 |
| **数据库** | SQLite | MySQL | 单机部署，无需额外运维，轻量够用 |
| **文件存储** | 本地磁盘（Local Storage） | MinIO / OSS | 个人中转站，本地存储成本最低 |
| **认证方案** | JWT + 简单账密 | Session | 无状态，易于实现 |
| **部署方式** | Docker Compose | 裸机部署 | 一键启动，环境隔离 |

---

## Step 3：架构设计

```
┌─────────────────────────────────────────────┐
│                  表现层 (Frontend)            │
│   Vue3 SPA                                   │
│   ┌──────────────┐    ┌───────────────────┐  │
│   │ 管理后台页面  │    │  访客下载页面      │  │
│   │(上传/管理/删除)│   │(输入提取码/下载)   │  │
│   └──────────────┘    └───────────────────┘  │
└───────────────────┬─────────────────────────┘
                    │ HTTP/REST API
┌───────────────────▼─────────────────────────┐
│                  业务层 (Backend)             │
│   FastAPI / Express                          │
│   ┌──────────┐ ┌──────────┐ ┌─────────────┐ │
│   │ 认证模块  │ │ 文件模块  │ │  分享链接模块│ │
│   └──────────┘ └──────────┘ └─────────────┘ │
└───────────────────┬─────────────────────────┘
                    │
┌───────────────────▼─────────────────────────┐
│                  数据层 (Data)                │
│   ┌──────────────┐    ┌───────────────────┐  │
│   │   SQLite DB   │    │   本地文件系统     │  │
│   │ (元数据/链接) │    │  /uploads/        │  │
│   └──────────────┘    └───────────────────┘  │
└─────────────────────────────────────────────┘
```

---

## Step 4：模块划分

| 模块 | 职责 | 关键功能 |
|------|------|----------|
| **认证模块** | 管理员登录鉴权 | 登录/登出、JWT 签发与验证、路由守卫 |
| **文件上传模块** | 处理文件上传 | 分片上传（大文件）、进度反馈、格式/大小校验 |
| **文件管理模块** | 文件列表与操作 | 查看列表、重命名、删除、文件详情 |
| **分享链接模块** | 生成与管理分享 | 生成短链、设置提取码、设置有效期、下载次数限制 |
| **访客下载模块** | 访客访问与下载 | 凭链接访问、提取码验证、文件流式下载 |
| **存储模块** | 文件 I/O 抽象 | 本地存储读写，预留 OSS 扩展接口 |

---

## Step 5：接口设计

### 5.1 认证接口

```http
POST /api/auth/login
Body: { "username": "admin", "password": "xxxx" }
Response: { "token": "jwt_token", "expires_in": 86400 }
```

### 5.2 文件管理接口（需 JWT）

```http
# 上传文件
POST /api/files/upload
Header: Authorization: Bearer <token>
Body: multipart/form-data { file, remark? }
Response: { "file_id": "uuid", "filename": "xxx.zip", "size": 1024 }

# 文件列表
GET /api/files?page=1&size=20&keyword=
Response: { "total": 100, "list": [ FileItem ] }

# 删除文件
DELETE /api/files/:file_id
Response: { "success": true }

# 生成分享链接
POST /api/files/:file_id/share
Body: { "password": "1234"(可选), "expire_hours": 24(可选), "max_downloads": 10(可选) }
Response: { "share_code": "abc123", "share_url": "https://domain/s/abc123" }

# 分享链接列表
GET /api/files/:file_id/shares
```

### 5.3 访客下载接口（无需登录）

```http
# 访问分享页（校验链接有效性）
GET /api/share/:share_code
Response: { "filename": "xxx.zip", "size": 1024, "need_password": true }

# 验证提取码并获取下载 Token
POST /api/share/:share_code/verify
Body: { "password": "1234" }
Response: { "download_token": "temp_token", "expires_in": 300 }

# 下载文件
GET /api/share/:share_code/download?token=<download_token>
Response: 文件流 (application/octet-stream)
```

### 错误码规范

| 错误码 | 含义 |
|--------|------|
| 401 | 未登录/Token 失效 |
| 403 | 无权限（管理员接口） |
| 404 | 文件/链接不存在 |
| 410 | 链接已过期或超下载次数 |
| 422 | 提取码错误 |
| 413 | 文件超过大小限制 |

---

## Step 6：数据模型设计

### 表：`files`（文件元数据）

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | VARCHAR(36) PK | UUID |
| `original_name` | VARCHAR(255) | 原始文件名 |
| `stored_name` | VARCHAR(255) | 磁盘存储文件名（防冲突） |
| `file_path` | VARCHAR(500) | 存储路径 |
| `file_size` | BIGINT | 文件大小（字节） |
| `mime_type` | VARCHAR(100) | 文件类型 |
| `remark` | VARCHAR(500) | 管理员备注 |
| `created_at` | DATETIME | 上传时间 |
| `updated_at` | DATETIME | 更新时间 |

### 表：`share_links`（分享链接）

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | VARCHAR(36) PK | UUID |
| `file_id` | VARCHAR(36) FK | 关联文件 |
| `share_code` | VARCHAR(16) UNIQUE | 短码（URL 使用）|
| `password_hash` | VARCHAR(255) NULL | 提取码哈希，NULL=无密码 |
| `expire_at` | DATETIME NULL | 过期时间，NULL=永不过期 |
| `max_downloads` | INT NULL | 最大下载次数，NULL=不限 |
| `download_count` | INT DEFAULT 0 | 已下载次数 |
| `is_active` | BOOLEAN DEFAULT 1 | 是否启用 |
| `created_at` | DATETIME | 创建时间 |

### 表：`admin`（管理员账户）

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | INT PK | 主键 |
| `username` | VARCHAR(50) | 用户名 |
| `password_hash` | VARCHAR(255) | bcrypt 哈希 |
| `last_login_at` | DATETIME | 最后登录时间 |

---

## Step 7：关键设计决策

| 决策点 | 选择 | 理由 |
|--------|------|------|
| **文件存储位置** | 本地磁盘 | 个人使用，零成本；通过存储抽象层预留云存储扩展 |
| **下载安全** | 二次 Token 机制 | 防止直接暴露文件路径，download_token 5分钟有效 |
| **提取码存储** | bcrypt 哈希 | 避免明文存储，安全基线保障 |
| **数据库选型** | SQLite | 单机无运维负担，数据量小完全够用 |
| **大文件上传** | 支持分片（可选） | 若有大文件需求可开启，否则 v1.0 可先简单实现 |
| **管理员数量** | 单账户硬编码/初始化脚本 | 需求明确单管理员，无需复杂的用户管理 |

---

## Step 8：实现计划

```
Week 1：基础框架搭建
  ├── 项目脚手架（前端 Vue3 + 后端 FastAPI）
  ├── Docker Compose 配置
  ├── 数据库初始化脚本
  └── 管理员登录认证

Week 2：核心功能
  ├── 文件上传（含进度显示）
  ├── 文件列表与删除
  └── 分享链接生成（含提取码/有效期）

Week 3：访客功能 + 收尾
  ├── 访客下载页面
  ├── 提取码验证流程
  ├── 下载次数统计
  └── 基础样式打磨 + 部署文档
```

---

## 目录结构预览

```
file-transfer/
├── frontend/              # Vue3 前端
│   ├── src/
│   │   ├── views/admin/   # 管理后台页面
│   │   ├── views/share/   # 访客下载页面
│   │   └── api/           # 接口封装
├── backend/               # FastAPI 后端
│   ├── routers/           # 路由
│   ├── models/            # 数据模型
│   ├── services/          # 业务逻辑
│   └── storage/           # 存储抽象层
├── uploads/               # 文件存储目录
├── docker-compose.yml
└── README.md
```